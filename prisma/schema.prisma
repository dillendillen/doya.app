// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  TRAINER
  ASSISTANT
  FINANCE
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  DONE
}

enum PlanStatus {
  ACTIVE
  PAUSED
  COMPLETED
}

enum TaskStatus {
  INBOX
  DOING
  WAITING
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum FollowUpStatus {
  OPEN
  DONE
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
}

enum ConsentScope {
  INTERNAL
  SHARE_LATER
}

enum DocumentStatus {
  DRAFT
  SENT
  SIGNED
}

enum BookingStatus {
  REQUESTED
  CONFIRMED
  CANCELLED
}

enum DogSex {
  M
  F
}

enum PackageStatus {
  ACTIVE
  EXHAUSTED
  EXPIRED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CARD
  OTHER
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  passwordHash  String?   // For password-based authentication
  emailVerified DateTime? // Email verification timestamp
  role          UserRole
  locale        String    @default("en")
  workingHours  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sessionsAsTrainer Session[]
  bookings         Booking[]
  tasks             Task[]
  mediaShareLinks   MediaShareLink[]
  watchlistPins     WatchlistPin[]
  availabilitySlots AvailabilitySlot[]
  serviceOfferings  ServiceOffering[]
  auditLogs         AuditLog[]
  clientNotes       ClientNote[]
  
  // Tenant-scoped data (user owns these)
  clients           Client[]
  dogs              Dog[]           @relation("DogOwner")
  sessions          Session[]       @relation("SessionOwner")
  packages          Package[]
  invoices          Invoice[]
  payments          Payment[]
  bookingsOwned     Booking[]       @relation("BookingOwner")
  tasksOwned        Task[]          @relation("TaskOwner")
  mediaAssets       MediaAsset[]
  trainingPlans     TrainingPlan[]
  documents         ClientDocument[]
  auditLogsOwned    AuditLog[]      @relation("AuditLogOwner")
}

model Client {
  id        String   @id @default(cuid())
  userId    String   // Multi-tenant: owner of this client
  name      String
  phone     String?
  email     String?
  address   String?
  language  String?
  referral  String?
  vatId     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  dogs      Dog[]
  bookings  Booking[]
  sessions  Session[]
  packages  Package[]
  invoices  Invoice[]
  documents ClientDocument[]
  notesLog  ClientNote[]
  mediaShareLinks MediaShareLink[]
  watchlistPins   WatchlistPin[]

  @@index([userId])
}

model Dog {
  id              String    @id @default(cuid())
  userId          String    // Multi-tenant: owner of this dog
  clientId        String
  name            String
  breed           String?
  sex             DogSex
  dob             DateTime?
  weightKg        Float?
  medicalFlags    String[]
  triggers        String[]
  tags            String[]
  consentInternal Boolean   @default(true)
  consentShareLater Boolean @default(false)
  activePlanId    String?   @unique
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User                @relation("DogOwner", fields: [userId], references: [id], onDelete: Cascade)
  client          Client              @relation(fields: [clientId], references: [id], onDelete: Restrict)
  activePlan      TrainingPlan?       @relation(fields: [activePlanId], references: [id], onDelete: SetNull)
  trainingPlans   TrainingPlan[]
  sessions        Session[]
  bookings        Booking[]
  mediaAssets     MediaAsset[]
  documents       ClientDocument[]
  logs            DogLog[]
  timelineEntries DogTimelineEntry[]
  watchlistPins   WatchlistPin[]
  relatedTasks    Task[]

  @@index([userId])
  @@index([clientId])
}

model TrainingPlan {
  id          String      @id @default(cuid())
  userId      String      // Multi-tenant: owner of this plan
  dogId       String
  templateName String
  status      PlanStatus
  assignedOn  DateTime
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  dog         Dog                   @relation(fields: [dogId], references: [id], onDelete: Restrict)
  milestones  TrainingPlanMilestone[]
  tasks       PlanTask[]
  sessions    Session[]

  @@index([userId])
  @@index([dogId])
}

model TrainingPlanMilestone {
  id          String   @id @default(cuid())
  planId      String
  title       String
  criteria    String
  done        Boolean  @default(false)
  completedAt DateTime?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  plan        TrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId, order])
}

model PlanTask {
  id        String   @id @default(cuid())
  planId    String
  title     String
  status    String   @default("pending")
  due       DateTime?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  plan      TrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
}

model Booking {
  id        String        @id @default(cuid())
  userId    String        // Multi-tenant: owner of this booking
  clientId  String
  dogId     String?
  trainerId String?
  serviceId String?
  sessionId String?       @unique
  status    BookingStatus @default(REQUESTED)
  startTime DateTime
  endTime   DateTime
  location  String?
  notes     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime       @updatedAt

  // Relations
  user      User          @relation("BookingOwner", fields: [userId], references: [id], onDelete: Cascade)
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Restrict)
  dog       Dog?          @relation(fields: [dogId], references: [id], onDelete: SetNull)
  trainer   User?         @relation(fields: [trainerId], references: [id], onDelete: SetNull)
  service   ServiceOffering? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  session   Session?      @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([clientId])
  @@index([dogId])
}

model Session {
  id              String        @id @default(cuid())
  userId          String        // Multi-tenant: owner of this session
  dogId           String
  trainerId       String
  clientId        String?
  serviceId       String?
  planId          String?
  packageId       String?
  title           String?       // Session title/name
  startTime       DateTime
  location        String
  durationMinutes Int
  status          SessionStatus @default(SCHEDULED)
  objectives      String[]
  notes           String?
  scorecards      Json?
  travelMinutes   Int           @default(0)
  bufferMinutes   Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user            User              @relation("SessionOwner", fields: [userId], references: [id], onDelete: Cascade)
  dog             Dog               @relation(fields: [dogId], references: [id], onDelete: Restrict)
  trainer         User              @relation("SessionsAsTrainer", fields: [trainerId], references: [id], onDelete: Restrict)
  client          Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  service         ServiceOffering?  @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  plan            TrainingPlan?     @relation(fields: [planId], references: [id], onDelete: SetNull)
  package         Package?          @relation(fields: [packageId], references: [id], onDelete: SetNull)
  followUps       SessionFollowUp[]
  mediaAssets     MediaAsset[]
  invoiceItems    InvoiceItem[]
  relatedTasks    Task[]
  timelineEntries DogTimelineEntry[]
  booking         Booking?

  @@index([userId])
  @@index([dogId])
  @@index([trainerId])
  @@index([clientId])
}

model SessionFollowUp {
  id        String        @id @default(cuid())
  sessionId String
  text      String
  due       DateTime?
  status    FollowUpStatus @default(OPEN)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  session   Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model Task {
  id              String       @id @default(cuid())
  userId          String       // Multi-tenant: owner of this task
  title           String
  due             DateTime?
  status          TaskStatus   @default(INBOX)
  priority        TaskPriority @default(MEDIUM)
  assigneeId      String
  relatedDogId    String?
  relatedClientId String?
  relatedSessionId String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  user            User         @relation("TaskOwner", fields: [userId], references: [id], onDelete: Cascade)
  assignee        User         @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: Restrict)
  relatedDog      Dog?         @relation(fields: [relatedDogId], references: [id], onDelete: SetNull)
  relatedClient   Client?      @relation(fields: [relatedClientId], references: [id], onDelete: SetNull)
  relatedSession  Session?     @relation(fields: [relatedSessionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([assigneeId])
  @@index([relatedDogId])
  @@index([relatedClientId])
}

model MediaAsset {
  id           String        @id @default(cuid())
  userId       String        // Multi-tenant: owner of this media
  url          String
  thumbUrl     String?
  dogId        String?
  sessionId    String?
  tags         String[]
  consentScope ConsentScope  @default(INTERNAL)
  uploadedAt   DateTime      @default(now())

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  dog          Dog?          @relation(fields: [dogId], references: [id], onDelete: SetNull)
  session      Session?      @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  shareLinks   MediaShareLink[]

  @@index([userId])
}

model MediaShareLink {
  id        String       @id @default(cuid())
  title     String
  expiresAt DateTime?
  token     String       @unique
  trainerId String
  clientId  String?
  createdAt DateTime     @default(now())

  // Relations
  trainer   User         @relation(fields: [trainerId], references: [id], onDelete: Restrict)
  client    Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)
  assets    MediaAsset[]
}

model Package {
  id           String        @id @default(cuid())
  userId       String        // Multi-tenant: owner of this package
  clientId     String
  type         String
  status       PackageStatus @default(ACTIVE)
  totalCredits Int
  usedCredits  Int           @default(0)
  priceCents   Int
  currency     String
  expiresOn    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  client       Client        @relation(fields: [clientId], references: [id], onDelete: Restrict)
  sessions     Session[]
  invoices     Invoice[]

  @@index([userId])
  @@index([clientId])
}

model Invoice {
  id         String        @id @default(cuid())
  userId     String        // Multi-tenant: owner of this invoice
  clientId   String
  packageId  String?
  status     InvoiceStatus @default(DRAFT)
  totalCents Int
  currency   String
  invoiceNumber String?    // Invoice number for payment tracking
  issuedOn   DateTime?
  dueOn      DateTime?
  paidOn     DateTime?
  notes      String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime       @updatedAt

  // Relations
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  client     Client        @relation(fields: [clientId], references: [id], onDelete: Restrict)
  package    Package?      @relation(fields: [packageId], references: [id], onDelete: SetNull)
  items      InvoiceItem[]
  payments   Payment[]

  @@index([userId])
  @@index([clientId])
}

model InvoiceItem {
  id             String   @id @default(cuid())
  invoiceId      String
  sessionId      String?
  description    String
  quantity       Int      @default(1)
  unitPriceCents Int
  createdAt      DateTime @default(now())

  // Relations
  invoice        Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  session        Session? @relation("SessionInvoiceItems", fields: [sessionId], references: [id], onDelete: SetNull)
}

model Payment {
  id          String        @id @default(cuid())
  userId      String        // Multi-tenant: owner of this payment
  invoiceId   String
  amountCents Int
  currency    String
  method      PaymentMethod
  receivedOn  DateTime
  reference   String?
  createdAt   DateTime      @default(now())

  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoice     Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([invoiceId])
}

model ClientDocument {
  id        String        @id @default(cuid())
  userId    String        // Multi-tenant: owner of this document
  clientId  String
  dogId     String?
  title     String
  url       String
  status    DocumentStatus @default(DRAFT)
  uploadedAt DateTime     @default(now())

  // Relations
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Restrict)
  dog       Dog?          @relation(fields: [dogId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([clientId])
}

model ClientNote {
  id        String   @id @default(cuid())
  clientId  String
  authorId  String?
  body      String
  createdAt DateTime @default(now())

  // Relations
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  author    User?    @relation(fields: [authorId], references: [id], onDelete: SetNull)
}

model DogLog {
  id        String   @id @default(cuid())
  dogId     String
  text      String
  createdAt DateTime @default(now())

  // Relations
  dog       Dog      @relation(fields: [dogId], references: [id], onDelete: Cascade)
}

model DogTimelineEntry {
  id              String   @id @default(cuid())
  dogId           String
  relatedSessionId String?
  type            String
  title           String
  description     String?
  occurredAt      DateTime
  createdAt       DateTime @default(now())

  // Relations
  dog             Dog      @relation(fields: [dogId], references: [id], onDelete: Cascade)
  relatedSession  Session? @relation(fields: [relatedSessionId], references: [id], onDelete: SetNull)
}

model WatchlistPin {
  id        String   @id @default(cuid())
  trainerId String
  dogId     String?
  clientId  String?
  createdAt DateTime @default(now())

  // Relations
  trainer   User     @relation(fields: [trainerId], references: [id], onDelete: Restrict)
  dog       Dog?     @relation(fields: [dogId], references: [id], onDelete: SetNull)
  client    Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([trainerId])
  @@index([dogId])
  @@index([clientId])
}

model AvailabilitySlot {
  id        String   @id @default(cuid())
  trainerId String?
  dayOfWeek Int
  startTime String
  endTime   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trainer   User?    @relation(fields: [trainerId], references: [id], onDelete: SetNull)
}

model ServiceOffering {
  id          String   @id @default(cuid())
  trainerId   String?
  name        String
  durationMin Int
  priceCents  Int
  currency    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  trainer     User?    @relation(fields: [trainerId], references: [id], onDelete: SetNull)
  bookings    Booking[]
  sessions    Session[]
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?  // Multi-tenant: owner of this audit log (can be null for system actions)
  actorId   String?  // User who performed the action
  action    String
  entityType String
  entityId  String?
  summary   String
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  user      User?    @relation("AuditLogOwner", fields: [userId], references: [id], onDelete: SetNull)
  actor     User?    @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([actorId])
  @@index([entityType, entityId])
}

